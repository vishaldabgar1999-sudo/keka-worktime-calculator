<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Keka Attendance Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{ --accent:#4f46e5; --bg:#f5f7ff; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --danger:#ef4444; }
body.dark{ --bg:#020617; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#1e293b; }
*{box-sizing:border-box}
body{ margin:0; font-family:Inter, sans-serif; background:var(--bg); color:var(--text); display:flex; justify-content:center; padding:12px; }
.app{width:100%; max-width:900px}
.header{display:flex; justify-content:space-between; align-items:center; margin-bottom:18px}
.grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
@media(max-width:768px){.grid{grid-template-columns:1fr}}
.card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px}
.hour-chips{display:flex; gap:8px; margin-bottom:12px}
.chip{padding:6px 12px; border:1px solid var(--border); border-radius:20px; cursor:pointer; font-size:13px; font-weight:600}
.chip.active{background:var(--accent); color:white; border-color:var(--accent)}
textarea{ width:100%; min-height:250px; padding:12px; border-radius:10px; border:1px solid var(--border); font-family:monospace; background:transparent; color:var(--text); line-height:1.5; }
.progress-box{display:flex; align-items:center; gap:20px}
svg{width:100px; height:100px; transform: rotate(-90deg)}
circle{fill:none; stroke-width:8}
.bg-ring{stroke:var(--border)}
.fg-ring{stroke:var(--accent); stroke-linecap:round; transition: stroke-dashoffset 0.4s}
.stats{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:20px}
.stat-card{border:1px solid var(--border); border-radius:10px; padding:12px}
.stat-card h4{margin:0; font-size:11px; text-transform:uppercase; color:var(--muted)}
.stat-card p{margin:5px 0 0; font-size:18px; font-weight:800}
.leave-banner{ margin-top:15px; padding:15px; border-radius:12px; background:var(--accent); color:white; text-align:center; }
.status-tag{ display:none; align-items:center; gap:5px; color:var(--danger); font-size:12px; font-weight:bold; margin-top:5px; }
.dot{ width:8px; height:8px; background:var(--danger); border-radius:50%; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h2>‚è± Keka Leave Calculator</h2>
    <button onclick="document.body.classList.toggle('dark')" style="cursor:pointer; border:none; background:none; font-size:20px">üåì</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hour-chips" id="chips">
        <div class="chip active" data-sec="30600">8.5 Hours</div>
        <div class="chip" data-sec="27000">7.5 Hours</div>
        <div class="chip" data-sec="16200">4.5 Hours</div>
      </div>
      <textarea id="logs" placeholder="Paste logs here...&#10;9:32:02 AM&#10;1:00:18 PM"></textarea>
      <button onclick="clearLogs()" style="margin-top:10px; color:var(--danger); background:none; border:none; cursor:pointer">Clear Logs</button>
    </div>

    <div class="card">
      <div class="progress-box">
        <svg viewBox="0 0 100 100">
          <circle class="bg-ring" cx="50" cy="50" r="45"/>
          <circle class="fg-ring" id="ring" cx="50" cy="50" r="45"/>
        </svg>
        <div>
          <h1 id="percent" style="margin:0">0%</h1>
          <div class="status-tag" id="status"><span class="dot"></span> WORKING NOW</div>
        </div>
      </div>

      <div class="stats">
        <div class="stat-card"><h4>Total Worked</h4><p id="worked">0h 0m</p></div>
        <div class="stat-card"><h4>Remaining</h4><p id="remaining">--</p></div>
      </div>

      <div class="leave-banner">
        <small>Estimated Departure</small>
        <h2 id="leave" style="margin:5px 0 0">--:--</h2>
      </div>
    </div>
  </div>
</div>

<script>
const logsArea = document.getElementById('logs');
const ring = document.getElementById('ring');
const circumference = 2 * Math.PI * 45;
ring.style.strokeDasharray = circumference;

let goalSeconds = 30600;

// IMPROVED TIME PARSER (Handles HH:MM:SS AM/PM)
function parseTimeToSeconds(str) {
    if (!str) return null;
    const clean = str.trim().toUpperCase();
    // Regex matches H:M, H:M:S, and optional AM/PM
    const match = clean.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s?(AM|PM)?/);
    if (!match) return null;

    let hours = parseInt(match[1]);
    const mins = parseInt(match[2]);
    const secs = match[3] ? parseInt(match[3]) : 0;
    const ampm = match[4];

    if (ampm === 'PM' && hours < 12) hours += 12;
    if (ampm === 'AM' && hours === 12) hours = 0;

    return (hours * 3600) + (mins * 60) + secs;
}

function update() {
    const lines = logsArea.value.split('\n').filter(l => l.trim() !== '');
    let totalWorked = 0;
    let isWorking = false;

    for (let i = 0; i < lines.length; i += 2) {
        const start = parseTimeToSeconds(lines[i]);
        if (start === null) continue;

        if (lines[i + 1]) {
            let end = parseTimeToSeconds(lines[i + 1]);
            if (end < start) end += 86400; // Handle shifts past midnight
            totalWorked += (end - start);
        } else {
            // Odd entry: Calculate from start until "Now"
            const now = new Date();
            let currentSecs = (now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds();
            if (currentSecs < start) currentSecs += 86400;
            totalWorked += (currentSecs - start);
            isWorking = true;
        }
    }

    // Update UI
    const progress = Math.min(totalWorked / goalSeconds, 1);
    const offset = circumference - (progress * circumference);
    ring.style.strokeDashoffset = offset;
    
    document.getElementById('percent').innerText = Math.floor(progress * 100) + '%';
    document.getElementById('worked').innerText = formatDuration(totalWorked);
    document.getElementById('status').style.display = isWorking ? 'flex' : 'none';

    if (totalWorked >= goalSeconds) {
        document.getElementById('remaining').innerText = "Done";
        document.getElementById('leave').innerText = "Completed!";
    } else {
        const remaining = goalSeconds - totalWorked;
        document.getElementById('remaining').innerText = formatDuration(remaining);
        const leaveTime = new Date(Date.now() + remaining * 1000);
        document.getElementById('leave').innerText = leaveTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
}

function formatDuration(s) {
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return `${h}h ${m}m`;
}

function clearLogs() {
    logsArea.value = '';
    update();
}

// Handle Goal Selection
document.getElementById('chips').addEventListener('click', (e) => {
    if (e.target.classList.contains('chip')) {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        e.target.classList.add('active');
        goalSeconds = parseInt(e.target.dataset.sec);
        update();
    }
});

logsArea.addEventListener('input', update);
setInterval(update, 1000); // Live update for "Working" status
update();
</script>
</body>
</html>
